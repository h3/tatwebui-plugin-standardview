<div class="wrapper message-standardview-manager">

  <div movable-dialog title="'Filter'" ng-model="ctrl.filterPosition">
    <div class="filter-dialog">
      <form>
        <div class="input-group">
          <span class="input-group-addon" id="filter-fulltext"><i class="fa fa-font"></i></span>
          <input type="text" class="form-control" placeholder="text" ng-model="ctrl.tmpFilter.filterText" aria-describedby="filter-fulltext">
        </div>
        <div class="form-group">
          <input type="text" class="form-control" placeholder="open,doing" ng-model="ctrl.tmpFilter.filterInLabel" aria-describedby="filter-labels">
          <span id="helpBlock" class="help-block">
            <strong>{{ 'message_in' | translate }}</strong> <i class="fa fa-tags"></i> : {{ 'message_contains_labels' | translate }}
          </span>
        </div>
        <div class="form-group">
          <input type="text" class="form-control" placeholder="open,doing" ng-model="ctrl.tmpFilter.filterAndLabel" aria-describedby="filter-labels">
          <span id="helpBlock" class="help-block">
            <strong>{{ 'message_all' | translate }}</strong> <i class="fa fa-tags"></i> : {{ 'message_contains_all_labels' | translate }}
          </span>
        </div>
        <div class="form-group">
          <input type="text" class="form-control" placeholder="done" ng-model="ctrl.tmpFilter.filterNotLabel" aria-describedby="filter-hide-labels">
          <span id="helpBlock" class="help-block">
            <strong>{{ 'message_hide' | translate }}</strong> <i class="fa fa-tags"></i> : {{ 'message_hide_labels' | translate }}
          </span>
        </div>
        <div class="form-group">
          <input type="text" class="form-control" placeholder="PCC,STOCKAGE" ng-model="ctrl.tmpFilter.filterInTag" aria-describedby="filter-tags">
          <span id="helpBlock" class="help-block">
            <strong>{{ 'message_in' | translate }}</strong> <i class="glyphicon glyphicon-copyright-mark"></i> : {{ 'message_contains_tags' | translate }}
          </span>
        </div>
        <div class="form-group">
          <input type="text" class="form-control" placeholder="PCC,STOCKAGE" ng-model="ctrl.tmpFilter.filterAndTag" aria-describedby="filter-tags">
          <span id="helpBlock" class="help-block">
            <strong>{{ 'message_all' | translate }}</strong> <i class="glyphicon glyphicon-copyright-mark"></i> : {{ 'message_contains_all_tags' | translate }}
          </span>
        </div>
        <div class="form-group">
          <input type="text" class="form-control" placeholder="PCC,STOCKAGE" ng-model="ctrl.tmpFilter.filterNotTag" aria-describedby="filter-hide-tags">
          <span id="helpBlock" class="help-block">
            <strong>{{ 'message_hide' | translate }}</strong> <i class="glyphicon glyphicon-copyright-mark"></i> : {{ 'message_hide_all_tags' | translate }}
          </span>
        </div>
        <div class="form-group">
          <button type="submit" class="btn btn-primary btn-xs" ng-click="ctrl.filterSearch()">{{ 'message_search' | translate }}</button>
        </div>
      </form>
    </div>
  </div>

  <div data-ng-hide="ctrl.data.isTopicRw" class="alert alert-info fixed-alert">
    <i class="fa fa-info-circle"></i> {{ 'message_read_only' | translate}}
  </div>

  <div class="message-standardview-create">

      <div class="row standardview-footer">
        <form class="message-form" method="post" action="/">
          <div style="display: flex">
            <div class="input-message-container" data-ng-show="ctrl.data.isTopicRw">
              <div class="message-popup-results">
              </div>
              <textarea ng-enter="ctrl.createMessage()" dir="auto" name="msg" class="input-mdessage autogrow-short"
                data-ng-model="ctrl.currentMessage" placeholder="Your message here with #tag"
                style="height: 36px;"></textarea>
              <i ng-click="ctrl.createMessage()" class="icon-paper-plane fa fa-send-o" title="{{ 'message_send' | translate}}"></i>
            </div>
            <div class="filter" data-ng-click="ctrl.filterPosition.visible = true">
              <i class="fa fa-filter"></i>
            </div>
            <div class="filter" title="Toggle display replies" data-ng-click="ctrl.expandReplies=!ctrl.expandReplies">
              <i ng-class="ctrl.expandReplies ? 'fa fa-compress': 'fa fa-expand'"></i>
            </div>
          </div>
          <div data-ng-if="ctrl.currentMessage.length > 0" class="users-typing"><i>{{ 'message_characters_left' | translate }}: {{ctrl.data.topic.maxlength - ctrl.currentMessage.length}}</i></div>

          <div class="formatting-tips" aria-hidden="true" dir="auto"></div>
        </form>
          <span class="message-filters">
            <span class="badge" data-ng-click="ctrl.filterPosition.visible = true" data-ng-if="ctrl.filter.text"><i class="fa fa-font"></i> {{ctrl.filter.text}}
                <a role="button" ng-click="ctrl.tmpFilter.filterText = ''; ctrl.filterSearch()"><i class="fa fa-times"></i></a>
            </span>
            <span class="badge" data-ng-click="ctrl.filterPosition.visible = true" data-ng-if="ctrl.filter.label">in <i class="fa fa-tags"></i> : {{ctrl.filter.label}}
                <a role="button" ng-click="ctrl.tmpFilter.filterInLabel = ''; ctrl.filterSearch()"><i class="fa fa-times"></i></a>
            </span>
            <span class="badge" data-ng-click="ctrl.filterPosition.visible = true" data-ng-if="ctrl.filter.andLabel">all <i class="fa fa-tags"></i> : {{ctrl.filter.andLabel}}
                <a role="button" ng-click="ctrl.tmpFilter.filterAndLabel = ''; ctrl.filterSearch()"><i class="fa fa-times"></i></a>
            </span>
            <span class="badge" data-ng-click="ctrl.filterPosition.visible = true" data-ng-if="ctrl.filter.notLabel">hide <i class="fa fa-tags"></i> : {{ctrl.filter.notLabel}}
                <a role="button" ng-click="ctrl.tmpFilter.filterNotLabel = ''; ctrl.filterSearch()"><i class="fa fa-times"></i></a>
            </span>
            <span class="badge" data-ng-click="ctrl.filterPosition.visible = true" data-ng-if="ctrl.filter.tag">in <i class="glyphicon glyphicon-copyright-mark"></i> {{ctrl.filter.tag}}
                <a role="button" ng-click="ctrl.tmpFilter.filterInTag = ''; ctrl.filterSearch()"><i class="fa fa-times"></i></a>
            </span>
            <span class="badge" data-ng-click="ctrl.filterPosition.visible = true" data-ng-if="ctrl.filter.andTag">all <i class="glyphicon glyphicon-copyright-mark"></i> : {{ctrl.filter.andTag}}
                <a role="button" ng-click="ctrl.tmpFilter.filterAndTag = ''; ctrl.filterSearch()"><i class="fa fa-times"></i></a>
            </span>
            <span class="badge" data-ng-click="ctrl.filterPosition.visible = true" data-ng-if="ctrl.filter.notTag">hide <i class="glyphicon glyphicon-copyright-mark"></i> : {{ctrl.filter.notTag}}
                <a role="button" ng-click="ctrl.tmpFilter.filterNoTag = ''; ctrl.filterSearch()"><i class="fa fa-times"></i></a>
            </span>
            <span class="badge" data-ng-if="ctrl.filter.idMessage"> <i class="fa fa-envelope" title="message"></i> {{ctrl.filter.idMessage}}
                <a role="button" ng-click="ctrl.tmpFilter.idMessage = '-1'; ctrl.filterSearch()"><i class="fa fa-times"></i></a>
            </span>
          </span>
      </div>
  </div>

  <div class="row">
    <div data-ng-class="(message && message.displayed) ? 'message-standardview-list col-md-7': 'message-standardview-list col-md-12'">
      <table class="table table-striped table-responsive">
        <tbody>
          <tr ng-repeat="msg in ctrl.data.messages" ng-class="msg.displayed ? 'open': ''" class="tat-msg-wrapper" ng-show="!msg.hide">
            <td>
              <a data-ng-href="#" data-ng-click="ctrl.toggleMessage(msg)" class="tat-toggle-msg">
                <i ng-class="msg.displayed ? 'fa fa-angle-left': 'fa fa-angle-right'"></i>
              </a>
              <button ng-if="msg.replies.length" class="tat-replies-count badge btn-xs" title="Click to display replies to this message" data-ng-click="msg.displayReplies=!msg.displayReplies">
                {{msg.replies.length}}
              </button>
              <div class="tat-msg" ng-bind-html="msg.text | linky | nl2br | parseTags:msg.tags"></div>
              <div class="tat-meta">
                <span class="date" title="creation: {{msg.dateCreation * 1000| amCalendar}}, update: {{msg.dateUpdate * 1000| amCalendar}}">
                  {{msg.dateCreation * 1000| amDateFormat:'DD/MM, HH:mm:ss'}}
                </span>
                &ndash;
                <user-display username="msg.author.username" fullname="msg.author.fullname"></user-display>
                <span data-ng-show="msg.nbLikes" class="likers">
                    {{msg.nbLikes}} <i class="fa fa-thumbs-o-up"></i>
                </span>
                <span data-ng-repeat="label in msg.labels track by label.text" class="badge tlabel"
                  style="background-color: {{label.color}}; border-right-color: {{ label.color }}; color: {{ctrl.getBrightness(label.color)>130 ? '#000000' : '#ffffff' }}">
                  {{label.text}}
                </span>
              </div>
                <div class="tat-replies" ng-if="msg.displayReplies || ctrl.expandReplies">
                  <table class="table">
                    <tbody>
                    <tr data-ng-repeat="reply in msg.replies">
                      <td>
                        <div class="tat-msg" ng-bind-html="reply.text | linky | nl2br | parseTags:reply.tags"></div>
                        <div class="tat-meta">
                          <span class="date" title="creation: {{reply.dateCreation * 1000| amCalendar}}, update: {{reply.dateUpdate * 1000| amCalendar}}">
                            {{reply.dateCreation * 1000| amDateFormat:'DD/MM, HH:mm:ss'}}
                          </span>
                          &ndash;
                          <user-display username="reply.author.username" fullname="reply.author.fullname"></user-display>
                        </div>
                      </td>
                    </tr>
                    </tbody>
                  </table>
                </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="col-md-5" ng-if="message && message.displayed">
      <div class="standardview-message-right">
        <!--<button class="btn btn-default btn-xs pull-right" data-ng-click="ctrl.closeMessage()">X</button>-->
        <messages-standardview-item
               data-topic="ctrl.topic"
               data-message="message"
               data-is-topic-bookmarks="ctrl.isTopicBookmarks"
               data-is-topic-tasks="ctrl.isTopicTasks"
               data-is-topic-deletable-msg="ctrl.data.isTopicDeletableMsg"
               data-is-topic-updatable-msg="ctrl.data.isTopicUpdatableMsg"
               data-is-topic-deletable-all-msg="ctrl.data.isTopicDeletableAllMsg"
               data-is-topic-updatable-all-msg="ctrl.data.isTopicUpdatableAllMsg"
               data-is-topic-rw="ctrl.isTopicRw"></messages-standardview-item>
      </div>
    </div>
  </div>

  <div class="row more">
    <button data-ng-disabled="!ctrl.data.displayMore" data-ng-click="ctrl.loadMore()" class="btn btn-default">
      <span data-ng-show="!ctrl.data.displayMore">No</span>
      <span data-ng-show="ctrl.data.displayMore"><i class="fa fa-plus-circle"></i></span>
      More
    </button>
  </div>

</div>
